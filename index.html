<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Escena VR interactiva con animaciones + Joysticks</title>

    <!-- A-Frame y extras -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <!-- look-at (billboard para el texto) -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <!-- nipplejs para joysticks táctiles -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body { margin: 0; }
      /* Contenedores de joystick (solo UI en móvil) */
      #leftJoystick, #rightJoystick {
        position: absolute;
        bottom: 8vh;
        width: 30vw;
        height: 30vw;
        max-width: 220px;
        max-height: 220px;
        touch-action: none; /* evita el scrolling al usar joystick */
        z-index: 10;
        pointer-events: auto;
      }
      #leftJoystick { left: 3vw; }
      #rightJoystick { right: 3vw; }
      /* Ocultar joysticks en escritorio (opcinal) */
      @media (min-width: 900px) {
        #leftJoystick, #rightJoystick { display: none; }
      }
    </style>

    <script>
      // ====== CONTROLES VR, PC Y JOYSTICKS TÁCTILES ======
      AFRAME.registerComponent("vr-controls", {
        schema: {
          moveSpeed: { type: "number", default: 0.12 },
          rotateSpeed: { type: "number", default: 2.0 },
          deadzone: { type: "number", default: 0.15 },
        },
        init: function () {
          this.rig = document.querySelector("#rig");
          this.cam = document.querySelector("#mainCam");
          this.leftX = 0;
          this.leftY = 0;
          this.rightX = 0;

          // Referencias a mandos (VR)
          const leftHand = document.querySelector("#leftHand");
          const rightHand = document.querySelector("#rightHand");

          if (leftHand) {
            leftHand.addEventListener("thumbstickmoved", (evt) => {
              this.leftX = evt.detail.x;
              this.leftY = evt.detail.y;
            });
            leftHand.addEventListener("thumbstickpressed", () => {});
          }

          if (rightHand) {
            rightHand.addEventListener("thumbstickmoved", (evt) => {
              this.rightX = evt.detail.x;
            });
          }

          // === Joysticks táctiles (nipplejs) como fallback / en móvil ===
          // Creamos los contenedores desde JS para que pueda integrarse fácilmente
          this.setupTouchJoysticks();
        },

        setupTouchJoysticks: function () {
          // Evitar ejecutar varias veces
          if (this.joysticksSetup) return;
          this.joysticksSetup = true;

          // Crear contenedores si no existen (estan en el DOM)
          let leftDiv = document.getElementById("leftJoystick");
          let rightDiv = document.getElementById("rightJoystick");

          if (!leftDiv) {
            leftDiv = document.createElement("div");
            leftDiv.id = "leftJoystick";
            document.body.appendChild(leftDiv);
          }
          if (!rightDiv) {
            rightDiv = document.createElement("div");
            rightDiv.id = "rightJoystick";
            document.body.appendChild(rightDiv);
          }

          // Inicializar nipplejs
          const optionsLeft = {
            zone: leftDiv,
            mode: "static",
            position: { left: "50%", top: "50%" },
            color: "#00ffff",
            size: 120,
            restOpacity: 0.6,
          };

          const optionsRight = {
            zone: rightDiv,
            mode: "static",
            position: { left: "50%", top: "50%" },
            color: "#ff9900",
            size: 100,
            restOpacity: 0.6,
          };

          // managers
          this.leftManager = nipplejs.create(optionsLeft);
          this.rightManager = nipplejs.create(optionsRight);

          // left joystick: mueve (x,y)
          this.leftManager.on("move", (evt, data) => {
            if (!data || !data.vector) return;
            // vector.x, vector.y entre -1 y 1
            this.leftX = data.vector.x; // lateral
            this.leftY = -data.vector.y; // invertimos Y para que empuje hacia adelante cuando se empuje arriba
          });
          this.leftManager.on("end", () => {
            this.leftX = 0; this.leftY = 0;
          });

          // right joystick: rotación (solo eje X)
          this.rightManager.on("move", (evt, data) => {
            if (!data || !data.vector) return;
            this.rightX = data.vector.x;
          });
          this.rightManager.on("end", () => {
            this.rightX = 0;
          });
        },

        tick: function () {
          if (!this.rig || !this.cam) return;
          const data = this.data;
          const rigObj = this.rig.object3D;
          const camObj = this.cam.object3D;

          // Movimiento hacia la dirección de la cámara
          if (Math.abs(this.leftX) > data.deadzone || Math.abs(this.leftY) > data.deadzone) {
            const forward = new THREE.Vector3();
            camObj.getWorldDirection(forward);
            forward.y = 0;
            forward.normalize();

            const right = new THREE.Vector3();
            right.crossVectors(forward, new THREE.Vector3(0, 1, 0)).normalize();

            // Usamos clones porque multiplyScalar modifica el vector
            const moveForward = forward.clone().multiplyScalar(this.leftY * data.moveSpeed);
            const moveRight = right.clone().multiplyScalar(this.leftX * data.moveSpeed);
            rigObj.position.add(moveForward);
            rigObj.position.add(moveRight);
          }

          // Rotación del rig (usamos rightX)
          if (Math.abs(this.rightX) > data.deadzone) {
            rigObj.rotation.y -= this.rightX * data.rotateSpeed * 0.05;
          }
        },
      });

      // ====== REDIRECCIÓN CON LA MIRADA ======
      AFRAME.registerComponent("gaze-redirect", {
        schema: {
          url: { type: "string", default: "https://dylanpinilla.github.io/Museo/" },
          duration: { type: "number", default: 3000 },
        },
        init: function () {
          this.timer = null;
          this.el.addEventListener("mouseenter", () => {
            this.timer = setTimeout(() => {
              window.location.href = this.data.url;
            }, this.data.duration);
          });
          this.el.addEventListener("mouseleave", () => {
            if (this.timer) clearTimeout(this.timer);
          });
        },
      });

      // ====== ANIMACIONES Y REINICIO CADA 25 s ======
      window.addEventListener("load", () => {
        const posCapitan = { x: -45, y: 0, z: 10 };
        const rotCapitan = { x: 0, y: 90, z: 0 };
        const posDilan = { x: 1, y: 0, z: -10 };
        const rotDilan = { x: 0, y: 0, z: 0 };

        const capitanEl = document.getElementById("capitan");
        const dilanEl = document.getElementById("dilan");

        function aplicarAnimaciones() {
          capitanEl.setAttribute("animation-mixer", "clip: Armature; loop: repeat; timeScale: 0.5");
          capitanEl.setAttribute(
            "animation",
            "property: position; to: -10 0 10; dur: 16000; easing: linear; loop: false"
          );
          capitanEl.setAttribute(
            "animation__rotar",
            "property: rotation; to: 0 180 0; dur: 3000; easing: linear; delay: 13500; loop: false"
          );

          dilanEl.setAttribute("animation-mixer", "clip: Animation; loop: false; timeScale: 1");
          dilanEl.setAttribute(
            "animation__rotar",
            "property: rotation; to: 0 -60 0; dur: 2000; easing: linear; delay: 9000; loop: false"
          );
          dilanEl.setAttribute(
            "animation__mover",
            "property: position; to: -3 0 -7; dur: 2000; easing: linear; delay: 9000; loop: false"
          );
          dilanEl.setAttribute(
            "animation__mover_dos",
            "property: position; from: -3 0 -7; to: 1 0 -10; dur: 2000; easing: linear; delay: 14000; loop: false"
          );
        }

        function resetAnimaciones() {
          capitanEl.removeAttribute("animation-mixer");
          dilanEl.removeAttribute("animation-mixer");
          capitanEl.removeAttribute("animation");
          capitanEl.removeAttribute("animation__rotar");
          dilanEl.removeAttribute("animation__rotar");
          dilanEl.removeAttribute("animation__mover");
          dilanEl.removeAttribute("animation__mover_dos");

          capitanEl.setAttribute("position", posCapitan);
          capitanEl.setAttribute("rotation", rotCapitan);
          dilanEl.setAttribute("position", posDilan);
          dilanEl.setAttribute("rotation", rotDilan);
        }

        aplicarAnimaciones();
        setInterval(() => {
          resetAnimaciones();
          setTimeout(aplicarAnimaciones, 60);
        }, 25000);
      });
    </script>
  </head>

  <body>
    <!-- Contenedores para joysticks táctiles (se crearán de todos modos desde JS si no existen) -->
    <div id="leftJoystick"></div>
    <div id="rightJoystick"></div>
    
    <a-scene>
      <a-assets>
        <img id="skyTexture" src="https://cdn.aframe.io/a-painter/images/sky.jpg" />
      </a-assets>

      <a-sky id="background" src="#skyTexture" theta-length="90" radius="45"></a-sky>
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 1" position="2 4 3"></a-entity>

      <!-- Escenario -->
      <a-entity gltf-model="url(https://raw.githubusercontent.com/GabrielCaroG/modelo3d/main/Escenario.glb)"
                scale="1.5 1.5 1.5" position="0 0 0"></a-entity>

      <!-- Personajes -->
      <a-entity id="capitan"
                gltf-model="url(https://cdn.jsdelivr.net/gh/GabrielCaroG/modelo3d@main/CapitanAnimacion.glb)"
                scale="1 1 1"
                position="-45 0 10"
                rotation="0 90 0"></a-entity>

      <a-entity id="dilan"
                gltf-model="url(https://raw.githubusercontent.com/GabrielCaroG/modelo3d/main/Dilananimacion.glb)"
                scale="1 1 1"
                position="1 0 -10"></a-entity>

      <!-- RIG jugador con cámara y mandos -->
      <a-entity id="rig" position="0 1.6 5" vr-controls>
        <a-camera id="mainCam" wasd-controls look-controls>
          <a-cursor fuse="true" fuse-timeout="3000"
                    geometry="primitive:ring;radiusInner:0.01;radiusOuter:0.02"
                    material="color:white; shader:flat"></a-cursor>
        </a-camera>

        <a-entity id="leftHand" meta-touch-controls="hand: left; model: true"></a-entity>
        <a-entity id="rightHand" meta-touch-controls="hand: right; model: true"></a-entity>
      </a-entity>

      <!-- Círculo interactivo (portal) -->
      <a-circle id="portalCircle" class="interactivo"
                gaze-redirect="url: https://dylanpinilla.github.io/Museo/"
                position="14.94 1.6 3.66"
                rotation="-90 0 0"
                radius="1"
                color="#00ffff"
                material="emissive:#00ffff; emissiveIntensity:1.5"></a-circle>

      <!-- Texto encima del portal (siempre mira a la cámara) -->
      <a-entity id="portalText"
                position="14.94 2.4 3.66"
                look-at="#mainCam"
                text="value: Mire 5 segundos el círculo para volver al museo; align: center; wrapCount: 24; width: 2;"
                geometry="primitive: plane; height: 0; width: 0"
                >
      </a-entity>

      <!-- Luz del portal -->
      <a-entity light="type: point; color: #00ffff; intensity: 2; distance: 5"
                position="14.94 1.6 3.66"></a-entity>
    </a-scene>
  </body>
</html>
